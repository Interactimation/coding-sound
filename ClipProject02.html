<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="codingSoundFavicon.ico" />

    <title>Clip Project 02</title>

    <!--import Tone.js, link found here: https://cdnjs.com/libraries/tone-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.1.5/Tone.min.js"></script>

    <!--import the webpage's stylesheet-->
    <link rel="stylesheet" href="style.css" />

</head>

<body>

    <!-- this is the start of content -->
    <h1>Clip Player 02</h1>

    <!--create some buttons-->
    <button id="piano-btn">Piano</button>


    <!--BOTTOM-->
    <!--Nav Buttons-->
    <div class="button-row">
        <button class="left" onclick="location.href='index.html'">ToC</button>
        <button class="center"
            onclick="window.open('https://github.com/Interactimation/coding-sound/blob/main/ClipProject02.html', '_blank')">Code</button>
        <button class="right" onclick="window.open('ClipProject03.html')">Next</button>
    </div>

    <!--JAVASCRIPT-->
    <script>

        //var called "playing"
        let playing = false;
        //start and end vars
        let strt = 1;
        let nd = 1.2;
        //step var
        const step = 0.01; // how much to slide the window each loop
        
        //clip array
        let clips = ["audio/pianochords.mp3", "audio/kalimbatines.mp3"];
    

        // GRANULAR PLAYER
        //gain var 
        let grangain = new Tone.Gain(4);  
        let grain = new Tone.GrainPlayer({
            url: clips[0],
            reverse: true,
            loop: true,
            // many short grains
            grainSize: 0.05,     // smaller grains = more "spray"
            // lots of overlap = thick cloud
            overlap: 0.30,       // 0.2–0.5 is good for smear
            // pitch-shift via rate
            playbackRate: 10,   // < 1 = down, > 1 = up
            // extra detune in cents
            //detune: 600,          // try 200–1200

            loopStart: strt,
            loopEnd: nd,

            onload: () => {
                const window = nd - strt;              // size of the loop region
                const dur = grain.buffer.duration;     // full file length (seconds)

                // how long one loop takes in seconds:
                const loopTime = window / Math.abs(grain.playbackRate);

                setInterval(() => {
                    // slide the window
                    strt += step;
                    nd += step;

                    // wrap when we hit the end of the file
                    if (nd > dur) {
                        strt = 0;
                        nd = window;
                    }

                    grain.loopStart = strt;
                    grain.loopEnd = nd;
                }, loopTime * 1000); // ms
            }
        }).connect(grangain);

        grangain.toDestination();

        // attach event listeners to HTML buttons

        //piano
        document.getElementById("piano-btn").addEventListener("click", async () => {

            await Tone.start();      // unlock audio
            grain.url = clips[0]; //load the first item from clips into the grain url
            await Tone.loaded();     // ensure buffer ready


            if (!playing) {
                grain.start();         // (optionally: grain.start("+0", 0))
                playing = true;
            } else {
                grain.stop();
                playing = false;
            }


        });

    </script>

</body>

</html>